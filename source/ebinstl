#!/bin/bash

# === Colors ===
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# === Configuration ===
SSH_USER="root"
EXECUTABLE="eb"  # Name of the executable to transfer
EXEC_DEST="/bin/$EXECUTABLE"

NETWORKS=("172.17.212.0/22" "172.17.213.0/22")  # Multiple networks

# === Helper Functions ===

function scan_all() {
    echo -e "${BLUE}[*] Scanning multiple networks...${NC}"
    for net in "${NETWORKS[@]}"; do
        echo -e "${YELLOW}[~] Scanning $net${NC}"
        nmap -sn "$net" | grep "Nmap scan report" | awk '{print $5}'
    done | sort -V
}

function scan_114() {
    echo -e "${BLUE}[*] Scanning for hosts with hostname starting with 'SM'...${NC}"
    scan_all | while read ip; do
        host=$(ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no root@$ip "hostname 2>/dev/null")
        if [[ "$host" == SM* ]]; then
            echo "$ip $host"
        fi
    done
}

function install_on_host() {
    local ip=$1
    echo -e "${GREEN}[+] Installing on $ip...${NC}"

    # Copy executable
    scp "$EXECUTABLE" "root@$ip:/bin/" >/dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[+] Copied $EXECUTABLE to $ip:${EXEC_DEST}${NC}"
    else
        echo -e "${RED}[x] Failed to copy to $ip${NC}"
        return
    fi

    # Make it executable
    ssh "root@$ip" "chmod +x ${EXEC_DEST}" >/dev/null 2>&1

    # Run it
    ssh "root@$ip" "${EXEC_DEST} &" >/dev/null 2>&1

    echo -e "${GREEN}[+] Successfully installed and ran $EXECUTABLE on $ip${NC}"
}

function install_all() {
    scan_all | while read ip; do
        install_on_host "$ip"
    done
}

function install_114() {
    scan_114 | awk '{print $1}' | while read ip; do
        install_on_host "$ip"
    done
}

# === Main Logic ===

if [ $# -ne 2 ]; then
    echo -e "${RED}Usage: $0 [scan|install] [all|114]${NC}"
    exit 1
fi

ACTION=$1
TARGET=$2

case "$ACTION" in
    scan)
        case "$TARGET" in
            all) scan_all ;;
            114) scan_114 ;;
            *) echo -e "${RED}[x] Invalid target${NC}"; exit 1 ;;
        esac
        ;;
    install)
        case "$TARGET" in
            all) install_all ;;
            114) install_114 ;;
            *) echo -e "${RED}[x] Invalid target${NC}"; exit 1 ;;
        esac
        ;;
    *)
        echo -e "${RED}[x] Invalid action${NC}"
        exit 1
        ;;
esac
